# 🗄️ Day 3: データベース実習

## 🎯 このハンズオンで学ぶこと

- **RDS**: マネージドデータベースサービス
- **EC2とRDSの連携**: Webアプリケーションとデータベースの接続
- **セキュリティ設計**: プライベートサブネットでのDB配置
- **データ永続化**: Webアプリケーションでのデータ保存・取得

## 🏗️ 構築するシステム

```
🌐 インターネット → 🔒 ALB → 💻 EC2(Webアプリ) → 🗄️ RDS(MySQL)
                                                     ↓
                                              📊 データ永続化
```

**動作**: Node.js製の社員管理システムで、社員情報をデータベースに保存・表示・編集・削除（完全CRUD対応）

## ⏰ 所要時間

約50分

## 📋 前提条件

- AWS Academy Sandbox環境へのアクセス
- Day2で学んだVPC・EC2の知識

---

## 🚀 Phase 1: VPC・ネットワーク構築（15分）

### Step 1: カスタムVPC作成（10分）

⚠️ **重要**: AWS Academy SandboxではDefault VPCにプライベートサブネットがないため、カスタムVPCを作成します。

1. **VPCコンソール**にアクセス
2. 「VPCを作成」をクリック

#### VPC設定
- **作成するリソース**: VPCなど
- **名前タグの自動生成**: ✅️ チェック ON
- **名前タグ**: `プロジェクト` => `employee-app` に変更
- **IPv4 CIDR**: `10.0.0.0/16`

#### サブネット設定
- **アベイラビリティーゾーン数**: 2
- **パブリックサブネット数**: 2
- **プライベートサブネット数**: 2

#### サブネット CIDR ブロックをカスタマイズ

|サブネット|CIDRブロック|
|:---|:---:|
|us-east-1a のパブリックサブネット|10.0.0.0/24|
|us-east-1b のパブリックサブネット|10.0.1.0/24|
|us-east-1a のプライベートサブネット|10.0.2.0/24|
|us-east-1b のプライベートサブネット|10.0.3.0/24|


#### その他設定
- **NATゲートウェイ**: なし（コスト節約のため）
- **VPCエンドポイント**: なし

3. 「VPCを作成」をクリック
4. 作成完了まで約2-3分待機

### Step 2: サブネット確認（5分）

1. **VPCコンソール**で「サブネット」を選択
2. 作成されたサブネットを確認：
   - **パブリックサブネット**: `10.0.0.0/24`, `10.0.1.0/24`
   - **プライベートサブネット**: `10.0.2.0/24`, `10.0.3.0/24`

💡 **確認ポイント**: プライベートサブネットにはルートテーブルでインターネットゲートウェイへのルートがあるのに対して、プライベートサブネットにはルートテーブルでインターネットゲートウェイへのルートがないことを確認

---

## 🚀 Phase 2: RDSデータベース作成（20分）

### Step 1: データベースサブネットグループ作成（5分）

1. **RDSコンソール**にアクセス （Aurora and RDS）
2. 「サブネットグループ」→「DBサブネットグループを作成」

#### 基本設定
- **名前**: `employee-db-subnet-group`
- **説明**: `Employee management database subnet group`
- **VPC**: `employee-app-vpc`を選択

#### サブネット設定
- **アベイラビリティーゾーン**: 2つ以上選択
- **サブネット**: 各AZの**プライベートサブネット**を選択
  - `employee-app-vpc-subnet-private1-[AZ]`
  - `employee-app-vpc-subnet-private2-[AZ]`

### Step 2: セキュリティグループ作成（5分）

1. **EC2コンソール**→「セキュリティグループ」
2. 「セキュリティグループを作成」

#### 基本設定
- **セキュリティグループ名**: `database-sg`
- **説明**: `Security group for RDS database`
- **VPC**: `employee-app-vpc`

#### インバウンドルール
- この時点では「ルールなし」（後で、タイプ MySQL/Aurora (ポート3306)でソースを「WebサーバのセキュリティグループID」を指定するルールを追加する）

#### アウトバウンドルール
- 変更しないこと

### Step 3: RDSインスタンス作成（10分）

1. **RDSコンソール**→「データベース」→「データベースの作成」

#### エンジン設定
- **エンジンタイプ**: MySQL
- **バージョン**: MySQL 8.4.6
- **テンプレート**: サンドボックス

#### 設定
- **DBインスタンス識別子**: `employee-database`
- **マスターユーザー名**: `admin`
- **認証情報管理**: `セルフマネージド`
- **マスターパスワード**: `password123`（本番では強力なパスワードを使用すべき）

#### インスタンス設定
- **DBインスタンスクラス**: db.t3.micro
- **ストレージタイプ**: 汎用SSD(gp2)
- **割り当てストレージ**: 20 GiB

#### 接続設定
- **VPC**: `employee-app-vpc`
- **DBサブネットグループ**: `employee-db-subnet-group`
- **パブリックアクセス**: なし
- **VPCセキュリティグループ**: `database-sg` （`default` は消す）

#### 追加設定
- **🚨 初期データベース名**: `employeedb` ⚠️ **必須！忘れずに入力**
- **削除保護の有効化**: 無効（のまま）

💡 **重要**: 初期データベース名を設定しないと、後でアプリケーションが接続できません！


※ データベースの作成が完了し、ステータスが「利用可能」となるまで待ちます。(5分〜10分程度かかります)

---

## 🚀 Phase 2: Webアプリケーション構築（25分）

### Step 1: EC2インスタンス起動（10分）

1. **EC2コンソール**→「インスタンスを起動」

#### 基本設定
- **名前**: `employee-web-server`
- **AMI**: Amazon Linux 2023 AMI
- **インスタンスタイプ**: t3.micro

#### キーペア（ログイン）

- キーベアなしで続行（推奨されません）

#### ネットワーク設定

「編集」ボタンを押す  

- **VPC**: `employee-app-vpc`
- **サブネット**: パブリックサブネット（`employee-app-vpc-subnet-public1-[AZ]`）
- **パブリックIPの自動割り当て**: 有効化

#### セキュリティグループ
- **（新しい）セキュリティグループを作成**
- **セキュリティグループ名**: `web-server-sg`
- **インバウンドルール**:
  - ssh (ポート22): 削除
  - カスタムTCP (ポート3000): ソース 任意の場所（0.0.0.0/0） を追加

#### 高度な詳細
- **IAMインスタンスプロファイル**: `LabInstanceProfile`
- **ユーザーデータ**: <a href="https://github.com/haw/aws-education-materials/blob/main/day3/db-lab/materials/user-data-webapp.txt" target="_blank" rel="noopener noreferrer">user-data-webapp.txt</a> の内容をコピー

### Step 2: データベースセキュリティグループ更新（5分）

1. **EC2コンソール**→「セキュリティグループ」
2. `database-sg` を選択
3. 「インバウンドルール」→「インバウンドルールを編集」
4. タイプ「MySQL/Auroraルール」にソースを「`web-server-sg` のセキュリティグループID」とするルールを追加

### Step 3: アプリケーション設定（10分）

1. **EC2インスタンス**にSession Managerで接続
2. ユーザの切り替え
   ```bash
   sudo su - ec2-user
   ```
3. RDSエンドポイントを設定ファイルに反映
   ```bash
   cd /var/www/html
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[RDSエンドポイント]/' server.js
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[RDSエンドポイント]/' init_db.js
   ```
   
   💡 **RDSエンドポイント取得方法**: RDSコンソール→データベース→`employee-database`→接続とセキュリティ→エンドポイント

4. データベース初期化スクリプト実行
   ```bash
   node init_db.js
   ```

5. Node.jsアプリケーション再起動（設定反映のため）
   ```bash
   sudo systemctl restart employee-app
   ```

6. 起動確認
   ```bash
   sudo systemctl status employee-app
   ```

---

## 🚀 Phase 3: 動作確認とテスト（5分）

### Step 1: Webアプリケーションアクセス

1. EC2インスタンスのパブリックIPをコピー
2. ブラウザで `http://[パブリックIP]:3000` にアクセス
3. Node.js製社員管理システムが表示されることを確認

### Step 2: データベース機能テスト

1. **社員追加**: 新しい社員情報を入力・保存
2. **データ表示**: 保存した社員情報が一覧に表示されることを確認
3. **社員編集**: 既存社員の「編集」ボタンで情報更新
4. **社員削除**: 既存社員の「削除」ボタンで情報削除
5. **データ永続化**: ページを再読み込みしてもデータが残ることを確認

---

## 🎯 学習ポイント

### **RDSの利点**
- **マネージド**: OS・DB管理が不要
- **自動バックアップ**: データ保護が自動化
- **高可用性**: マルチAZ配置で障害対応
- **スケーラビリティ**: 必要に応じてスペック変更可能

### **セキュリティ設計**
- **プライベート配置**: データベースは外部から直接アクセス不可
- **セキュリティグループ**: Webサーバからのみアクセス許可
- **最小権限の原則**: 必要最小限の通信のみ許可

### **3層アーキテクチャの実現**
- **プレゼンテーション層**: Webブラウザ（EJSテンプレート）
- **アプリケーション層**: EC2上のNode.js + Expressアプリケーション
- **データ層**: RDS MySQL

---

## 🚨 トラブルシューティング

### **Webアプリケーションにアクセスできない**
1. EC2インスタンスが「running」状態か確認
2. セキュリティグループでポート80が開いているか確認
3. ユーザーデータスクリプトが正常実行されたか確認

### **データベースに接続できない**
1. RDSインスタンスが「available」状態か確認
2. データベースセキュリティグループの設定確認
3. 接続文字列（エンドポイント、ユーザー名、パスワード）の確認

### **データが保存されない**
1. データベース初期化スクリプトが実行されたか確認
2. Node.jsアプリケーションのログを確認
   ```bash
   sudo journalctl -u employee-app.service -f
   ```

### **アプリケーションが「Unknown database」エラー**
🚨 **原因**: RDS作成時に初期データベース名 `employeedb` を入力し忘れた
🔧 **解決策**: RDSを削除して再作成、またはMySQLクライアントで手動作成

### **ポート3000にアクセスできない**
🚨 **原因**: セキュリティグループでポート3000が開放されていない
🔧 **解決策**: `web-server-sg`のインバウンドルールでカスタムTCP（ポート3000）を追加

### **「Can't add new command when connection is in closed state」エラー**
🚨 **原因**: server.jsを更新後、Node.jsアプリケーションの再起動が必要
🔧 **解決策**: 
```bash
sudo systemctl restart employee-app
sudo systemctl status employee-app  # 状態確認
```

---

## 🎊 完了！

おめでとうございます！あなたは今、以下を達成しました：

✅ **マネージドデータベース**: RDSでMySQL構築  
✅ **Webアプリケーション**: EC2でNode.js + Expressアプリケーション実行  
✅ **完全CRUD操作**: データベースでの情報作成・読取・更新・削除  
✅ **セキュリティ設計**: プライベートDB配置とアクセス制御  
✅ **モダンWeb技術**: EJSテンプレート + レスポンシブUI  

### 🚀 次のステップ

明日（Day4）は、高可用性システムを構築します。今日作ったシステムを複数台構成にして、負荷分散と自動スケーリングを実現しましょう！

### 💡 今日の気づきを記録しよう

- RDSとEC2上のデータベースの違いは？
- セキュリティグループでの通信制御の重要性は？
- 3層アーキテクチャの各層の役割は？

**今日もお疲れさまでした！** 🔥