# 🔔 S3自動通知システム ハンズオン

## 🎯 このハンズオンで学ぶこと

- **イベント駆動アーキテクチャ**: ファイルアップロードをトリガーに自動処理
- **サーバーレス**: サーバー管理不要でシステム構築
- **AWS連携**: S3 → Lambda → SNS の連携パターン
- **実用的な通知システム**: 実際のシステムでよく使われる構成

## 🏗️ 構築するシステム

```
📁 S3バケット → ⚡ Lambda関数 → 📧 SNS → 📬 あなたのメール
```

**動作**: S3にファイルをアップロードすると、自動であなたのメールアドレスに通知が届きます！

## ⏰ 所要時間

約25分

## 📋 前提条件

- 受信可能なメールアドレス
- AWS Academy Sandbox環境へのアクセス

💡 **AWS Academy Sandbox対応**: このハンズオンはAWS Academy Sandbox環境で動作確認済みです！

---

## 🚀 手順

### Step 1: SNSトピック作成（5分）

1. AWSコンソールで「Simple Notification Service」を検索・選択
2. 「トピック」→「トピックの作成」
3. **タイプ**: スタンダード
4. **名前**: `file-upload-notifications`
5. 「トピックの作成」をクリック

### Step 2: メール購読設定（3分）

1. 作成したトピックをクリック
2. 「サブスクリプション」タブ→「サブスクリプションの作成」
3. **プロトコル**: Eメール
4. **エンドポイント**: あなたのメールアドレス
5. 「サブスクリプションの作成」をクリック
6. **重要**: メールに届く確認リンクをクリックして購読を確定

### Step 3: S3バケット作成（5分）

1. AWSコンソールで「S3」を検索・選択
2. 「バケットを作成」
3. **バケット名**: `notification-demo-[ランダム数字]`
4. **リージョン**: デフォルト（us-east-1）
5. その他はデフォルト→「バケットを作成」

### Step 4: Lambda関数作成（10分）

1. AWSコンソールで「Lambda」を検索・選択
2. 「関数の作成」
3. **関数名**: `s3-notification-handler`
4. **ランタイム**: Python 3.13 または Node.js 22.x (お好きな方を選んでください。どちらか迷ったらPythonを選んでください)
5. **実行ロール**: 「デフォルトの実行ロールの変更」→「既存のロールを使用する」→**LabRole**を選択
6. 「関数の作成」をクリック

#### Python版コード
`lambda-python.py` を参照してください。AWSコンソール上の「コード」タブで、Copy & Pasteしてください。  

#### Node.js版コード
`lambda-nodejs.js` を参照してください。AWSコンソール上の「コード」タブで、Copy & Pasteしてください。  

### Step 5: SNSトピックARNの設定（2分）

1. SNSコンソールでトピックのARNをコピー
2. Lambda関数のコードで `YOUR_TOPIC_ARN_HERE` を実際のARNに置換 (例: arn:aws:sns:us-east-1:975xxxxxxxx:file-upload-notifications)
3. 「Deploy」をクリック

### Step 6: S3イベント設定（5分）

1. S3コンソールで作成したバケットを選択
2. 「プロパティ」タブ
3. 「イベント通知」→「イベント通知を作成」
4. **名前**: `upload-notification`
5. **イベントタイプ**: 「すべてのオブジェクト作成イベント」にチェック
6. **送信先**: Lambda関数
7. **Lambda関数**: `s3-notification-handler`を選択
8. 「変更を保存」

⚠️ **重要な注意事項**: 

S3の「プロパティ」タブで以下のような赤い警告メッセージが表示される場合があります：

```
オブジェクトロックの詳細を取得するためのアクセス許可がありません
お客様またはお客様の AWS 管理者が、s3:GetBucketObjectLockConfiguration を許可するように IAM アクセス許可を更新する必要があります。
```

**この警告は完全に無視して大丈夫です！**

- **原因**: AWS Academy Sandbox環境の権限制限
- **影響**: 今回のハンズオンには一切影響なし
- **対処**: 何もする必要はありません
- **理由**: オブジェクトロック機能（ファイルの削除・変更を一定期間禁止する機能）は今回使用しないため

赤い警告で驚かれるかもしれませんが、**システムは正常に動作します**。安心して次のステップに進んでください。  

### Step 7: テスト実行（2分）

1. S3バケットに任意のファイルをアップロード
2. 数秒後にメールを確認
3. 🎉 通知メールが届いていれば成功！

---

## 🎯 学習ポイント

### **イベント駆動アーキテクチャ**
- ファイルアップロードが「イベント」
- Lambdaが「イベントハンドラー」
- 自動的に処理が実行される

### **サーバーレスの利点**
- サーバー管理不要
- 使った分だけ課金
- 自動スケーリング

### **AWS連携パターン**
- S3 → Lambda → SNS は実用的な構成
- 監視、通知、データ処理で頻繁に使用

---

## 🚨 トラブルシューティング

### **メールが届かない**
- SNS購読の確認メールをクリックしたか確認
- スパムフォルダも確認
- Lambda関数のCloudWatchログを確認

### **Lambda関数でエラー**
- SNSトピックARNが正しく設定されているか確認
- IAMロールにSNS権限があるか確認
- CloudWatchログでエラー詳細を確認

### **S3イベントが発火しない**
- イベント通知設定が正しいか確認
- Lambda関数名が正しいか確認

---

## 🎊 完了！

おめでとうございます！あなたは今、実用的なサーバーレス通知システムを構築しました。

この技術は実際のシステムで：
- ファイル処理の完了通知
- システム監視アラート  
- データ更新の通知

などに活用されています。

**次のステップ**: 他のAWSサービスとの連携を学んで、より複雑なシステムを構築してみましょう！