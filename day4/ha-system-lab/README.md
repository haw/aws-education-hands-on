# ⚖️ Day 4: 高可用性システム ハンズオン

> **HA = High Availability（高可用性）**  
> High Availabilityの略語として「HA」は広く使われていますが、  
> リソース名の「ha-」プレフィックスについては  
> 組織や開発者の命名ポリシーによる個別の選択です。  

## 🎯 このハンズオンで学ぶこと

- **高可用性**: 単一障害点を排除したシステム設計
- **Application Load Balancer**: 複数サーバへの負荷分散
- **冗長化**: 障害時でもサービス継続する仕組み
- **可用性テスト**: 実際に障害を発生させて動作確認

## 🏗️ 構築するシステム

```
🌐 インターネット → ⚖️ ALB → 💻 EC2-1(Webアプリ) → 🗄️ RDS(MySQL)
                      ↓    💻 EC2-2(Webアプリ) ↗
                  負荷分散      冗長化構成
```

**動作**: Day3の社員管理システムを2台構成にして、1台停止してもサービス継続

## ⏰ 所要時間

約60分（発表準備時間含む）

## 📋 前提条件

- AWS Academy Sandbox環境へのアクセス
- Day3で学んだVPC・EC2・RDSの知識

---

## 🚀 Phase 1: 基盤構築（Day3の復習）（20分）

### Step 1: VPC・RDS構築（15分）

Day 3と同じ手順でVPCとRDSを構築します。  
参考: <a href="../../day3/db-lab/" target="_blank" rel="noopener noreferrer">Day 3の手順</a>  

以下、Day 3のポイントのみ示します。  

#### VPC作成
1. **VPCコンソール**→「VPCを作成」
2. **設定**:
   - **名前**: `employee-app-vpc` （`プロジェクト` => `employee-app` に変更で `-vpc` はサフィックスされる)
   - **IPv4 CIDR**: `10.0.0.0/16`
   - **AZ数**: 2、**パブリック**: 2、**プライベート**: 2
   - **NATゲートウェイ**: なし

#### RDS作成
1. **サブネットグループ作成**: `employee-db-subnet-group`
2. **セキュリティグループ作成**: `database-sg`
3. **RDS作成**:
   - **識別子**: `employee-database`
   - **エンジン**: MySQL 8.4.6
   - **🚨初期データベース名**: `employeedb`
   - **VPC**: `employee-app-vpc`

### Step 2: 状態確認（5分〜10分）

RDSが「利用可能」状態になるまで、5分〜10分程度時間がかかります。  
ここで待つ必要はありませんので、次へ進みましょう。  

---

## 🚀 Phase 2: 高可用性Webサーバ構築（25分）

### Step 1: 1台目のEC2インスタンス作成（10分）

1. **EC2コンソール**→「インスタンスを起動」

#### 基本設定
- **名前**: `ha-web-server-1`
- **AMI**: Amazon Linux 2023 AMI
- **インスタンスタイプ**: t3.micro

#### キーペア（ログイン）

- キーベアなしで続行（推奨されません）

#### ネットワーク設定

「編集」ボタンを押す  

- **VPC**: `employee-app-vpc`
- **サブネット**: パブリックサブネット1
- **パブリックIP**: 有効

#### セキュリティグループ
- **新規作成**: `ha-web-server-sg`
- **インバウンドルール**:
  - カスタムTCP (3000): 0.0.0.0/0 （任意の場所）
  - SSH (22): 削除

#### 高度な詳細
- **IAMプロファイル**: `LabInstanceProfile`
- **ユーザーデータ**: Day3の <a href="https://github.com/haw/aws-education-materials/blob/main/day3/db-lab/materials/user-data-webapp.txt" target="_blank" rel="noopener noreferrer">user-data-webapp.txt</a> をコピー（Node.js版）

### Step 2: 2台目のEC2インスタンス作成（10分）

1. **EC2コンソール**→「インスタンスを起動」

#### 基本設定
- **名前**: `ha-web-server-2`
- **AMI**: Amazon Linux 2023 AMI
- **インスタンスタイプ**: t3.micro

#### キーペア（ログイン）

- キーベアなしで続行（推奨されません）

#### ネットワーク設定
- **VPC**: `employee-app-vpc`
- **サブネット**: パブリックサブネット2（異なるAZ）
- **パブリックIP**: 有効

#### セキュリティグループ
- **既存選択**: `ha-web-server-sg`

#### 高度な詳細
- **IAMプロファイル**: `LabInstanceProfile`
- **ユーザーデータ**: Day3の <a href="https://github.com/haw/aws-education-materials/blob/main/day3/db-lab/materials/user-data-webapp.txt" target="_blank" rel="noopener noreferrer">user-data-webapp.txt</a> をコピー（Node.js版）  

### Step 3: データベースセキュリティグループ更新（5分）

1. **EC2コンソール**→「セキュリティグループ」
2. `database-sg` を選択
3. 「インバウンドルール」→「インバウンドルールを編集」
4. タイプ「MySQL/Auroraルール」にソースを「`ha-web-server-sg` のセキュリティグループID」とするルールを追加

### Step 4: データベース接続設定（5分）

**RDSコンソールにて、作成したデータベースの状態が「利用可能」となっていることを確認する。**  
「利用可能」となるまで待つ。  

#### 1台目のみで実行（ha-web-server-1）

1. **Session Manager**で`ha-web-server-1`に接続
2. **ユーザ切り替え**:
   ```bash
   sudo su - ec2-user
   cd /var/www/html
   ```
3. **RDSエンドポイント更新**:
   ```bash
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[実際のエンドポイント]/' server.js
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[実際のエンドポイント]/' init_db.js
   ```

   💡 **RDSエンドポイント取得方法**: RDSコンソール→データベース→`employee-database`→接続とセキュリティ→エンドポイント  
   `[RDSエンドポイント]`を置き換えて、コマンドを実行すること。  

4. **データベース初期化**:
   ```bash
   node init_db.js
   ```
5. **Node.jsアプリケーション再起動**:
   ```bash
   sudo systemctl restart employee-app
   ```
6. **動作確認**:
   ```bash
   # 1台目のパブリックIPでアクセステスト（ブラウザでアクセスする）
   http://[1台目のパブリックIP]:3000
   ```

#### 2台目で実行（ha-web-server-2）

1. **Session Manager**で`ha-web-server-2`に接続
2. **ユーザ切り替え**:
   ```bash
   sudo su - ec2-user
   cd /var/www/html
   ```
3. **RDSエンドポイント更新**のみ:
   ```bash
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[実際のエンドポイント]/' server.js
   sudo sed -i 's/YOUR_RDS_ENDPOINT_HERE/[実際のエンドポイント]/' init_db.js
   ```

   💡 **RDSエンドポイント取得方法**: RDSコンソール→データベース→`employee-database`→接続とセキュリティ→エンドポイント  
   `[RDSエンドポイント]`を置き換えて、コマンドを実行すること。  

4. **Node.jsアプリケーション再起動**:
   ```bash
   sudo systemctl restart employee-app
   ```
5. **動作確認**:
   ```bash
   # 2台目のパブリックIPでアクセステスト（ブラウザでアクセスする）
   http://[2台目のパブリックIP]:3000
   ```

⚠️ **重要**: データベース初期化（init_db.js）は1台目でのみ実行してください！

---

## 🚀 Phase 3: Application Load Balancer構築（10分）

### Step 1: ターゲットグループ作成（5分）

1. **EC2コンソール**→「ターゲットグループ」→「ターゲットグループの作成」

#### 基本設定
- **ターゲットタイプ**: インスタンス
- **ターゲットグループ名**: `ha-web-targets`
- **プロトコル**: HTTP、**ポート**: 3000
- **VPC**: `employee-app-vpc`

#### ヘルスチェック
- **ヘルスチェックパス**: `/`
- **ヘルスチェックの詳細設定**
  - **正常しきい値**: 2 （デフォルト値 `5` から変更）
  - **間隔**: 30秒

「次へ」  

#### ターゲット登録
- `ha-web-server-1`と`ha-web-server-2`を選択し、「保留中として以下を含める」
- ターゲットグループの作成

### Step 2: Application Load Balancer作成（5分）

1. **EC2コンソール**→「ロードバランサー」→「ロードバランサーの作成」

#### 基本設定
- **タイプ**: Application Load Balancer
- **名前**: `ha-system-alb`
- **スキーム**: インターネット向け

#### ネットワークマッピング
- **VPC**: `ha-system-vpc`
- **サブネット**: 両方のパブリックサブネットを選択

#### セキュリティグループ
- **新規作成**: `ha-alb-sg` (「名前」と「説明」を入力する)
- **インバウンドルール**: HTTP (80): 0.0.0.0/0 (Anywhere IPv4)
- **アウトバウンドルール**: ⚠️変更しないこと

※「新しいセキュリティグループを作成↗」リンクから作成可能です。作成後、「更新🌀」ボタンを押下して選択してください。  

#### リスナーとルーティング
- **プロトコル**: HTTP、**ポート**: 80
- **デフォルトアクション**: `ha-web-targets`に転送
- **ポートマッピング**: 80 → 3000（ALBが自動変換）

その他は、デフォルトのまま、「ロードバランサーの作成」

---

## 🔒 Phase 4: セキュリティ強化（5分）

### Step 1: Webサーバセキュリティグループ更新

1. **EC2コンソール**→「セキュリティグループ」
2. `ha-web-server-sg`を選択
3. 「インバウンドルール」→「インバウンドルールを編集」
4. **既存ルール削除**: カスタムTCP (3000): 0.0.0.0/0
5. **新規ルール追加**: 
   - **タイプ**: カスタムTCP
   - **ポート**: 3000
   - **ソース**: `ha-alb-sg`（ALBのセキュリティグループを選択）

💡 **セキュリティ向上**: これでWebサーバへの直接アクセスを防ぎ、ALB経由のみに制限されます

### 🎯 学習ポイント
- **多層防御**: ALBとEC2で二重のセキュリティ制御
- **最小権限の原則**: 必要最小限のアクセスのみ許可
- **本番運用設計**: 実際のWebサービスで使われるセキュリティ設計

---

## 🚀 Phase 5: 高可用性テスト（10分）

### Step 1: 正常動作確認（3分）

1. **ALBのDNS名**をコピー
2. ブラウザで`http://[ALB-DNS名]`にアクセス
3. 社員管理システムが表示されることを確認
4. 社員データを追加して動作確認

### Step 2: 可用性テスト（5分）

1. **EC2コンソール**で`ha-web-server-1`を選択
2. 「インスタンスの状態」→「インスタンスを停止」
3. **ブラウザを更新**してシステムが継続動作することを確認
4. **ターゲットグループ**でヘルスチェック状況を確認

### Step 3: 復旧テスト（2分）

1. 停止したインスタンスを「開始」
2. ターゲットグループで「Healthy」に戻ることを確認
3. 負荷分散が再開されることを確認

---

## 📸 発表準備のポイント

### 🎯 スクリーンショット推奨箇所

1. **システム構成図**: VPC、EC2×2、ALB、RDSの配置
2. **ALBターゲットグループ**: 両方のインスタンスがHealthy
3. **正常動作**: ALB経由でのアプリケーション画面
4. **障害テスト**: 1台停止時の継続動作
5. **ヘルスチェック**: Unhealthy→Healthyの変化

### 💡 発表で語るべきポイント

- **単一障害点の排除**: 1台停止してもサービス継続
- **負荷分散の効果**: トラフィック分散によるパフォーマンス向上
- **ヘルスチェック**: 自動的な障害検知と切り離し
- **マルチAZ配置**: 異なるデータセンターでの冗長化
- **セキュリティ強化**: ALB経由のみのアクセス制限で多層防御を実現

<a href="../../day5/materials/presentation_format.html" target="_blank" rel="noopener noreferrer">成果発表フォーマット</a>  

---

## 🎯 学習ポイント

### **高可用性の実現**
- **冗長化**: 複数のサーバで同じサービスを提供
- **負荷分散**: トラフィックを複数サーバに分散
- **自動復旧**: 障害サーバの自動切り離しと復帰

### **Application Load Balancerの価値**
- **Layer 7負荷分散**: HTTPレベルでの高度な制御
- **ヘルスチェック**: 自動的な障害検知
- **スケーラビリティ**: サーバ台数の柔軟な増減

### **セキュリティ設計**
- **多層防御**: ALBとEC2で二重のセキュリティ制御
- **最小権限の原則**: 必要最小限のアクセスのみ許可
- **ネットワーク分離**: 直接アクセスの防止

### **本番運用への応用**
- **Auto Scaling**: 負荷に応じた自動スケーリング
- **CloudWatch**: 監視とアラート
- **マルチAZ RDS**: データベースの高可用性

---

## 🚨 トラブルシューティング

### **ALBでアクセスできない**
1. セキュリティグループでポート80が開いているか確認
2. ターゲットグループのヘルスチェック状況確認
3. EC2インスタンスが正常に起動しているか確認

### **ヘルスチェックがUnhealthy**
1. EC2インスタンスでNode.jsアプリケーションが起動しているか確認: `sudo systemctl status employee-app`
2. ユーザーデータスクリプトが正常実行されたか確認
3. セキュリティグループでALBからのポート3000への通信が許可されているか確認

### **データベース接続エラー**
1. RDSセキュリティグループでEC2からの接続が許可されているか確認
2. server.jsとinit_db.jsのエンドポイント設定確認
3. 初期データベース名の設定確認
4. Node.jsアプリケーションログ確認: `sudo journalctl -u employee-app.service -f`

---

## 🎊 完了！

おめでとうございます！あなたは今、以下を達成しました：

✅ **高可用性システム**: 単一障害点を排除した冗長構成  
✅ **負荷分散**: Application Load Balancerによるトラフィック分散  
✅ **障害対応**: 1台停止してもサービス継続する仕組み  
✅ **セキュリティ強化**: ALB経由のみのアクセスで多層防御を実現  
✅ **本番レベル**: 実際のWebサービスで使われる構成  

### 🚀 明日の発表会に向けて

今日構築したシステムは、実際のWebサービスで使われている本格的な高可用性構成です。明日の発表では、この経験を活かして、クラウドエンジニアとしての成長をアピールしましょう！

### 💡 今日の気づきを記録しよう

- 単一障害点とは何か？どう解決したか？
- 負荷分散の仕組みと効果は？
- 高可用性システムの設計思想は？

**明日の発表、頑張りましょう！** 🔥