# 問題12: 3層アーキテクチャ構築（実技試験）


## 🎯 問題

以下の要件を満たす3層アーキテクチャシステムを構築してください。

## 🔧 参考手順

<a href="https://haw.github.io/aws-education-hands-on/day4/ha-system-lab/" target="_blank" rel="noopener noreferrer">Day 4: 高可用性システム ハンズオン</a> (※別タブで開きます)  

※ **この問題は、「参考手順」をそのまま進めることで、「要件」を満たせます。**  

---

## 要件

#### 1. ネットワーク構成

- **VPC**: CIDR 10.0.0.0/16
- **パブリックサブネット**: 2つ（異なるAZ）
- **プライベートサブネット**: 2つ（異なるAZ）
- **NATゲートウェイ**: なし
- **VPCエンドポイント**: なし

#### 2. ロードバランサー

- **Application Load Balancer**
- **ターゲット**: 2台のEC2インスタンス

#### 3. Webサーバー（EC2）

- **インスタンス数**: 2台
- **配置**: 異なる**パブリックサブネット**
- **インスタンスタイプ**: t3.micro
- **OS**: Amazon Linux 2023
- **アプリ**: ユーザーデータにセットできるスクリプトを提供
    - [user-data-webapp.txt](https://github.com/haw/aws-education-hands-on/blob/main/day3/db-lab/materials/user-data-webapp.txt)
        - 5行目の `YOUR_RDS_ENDPOINT_HERE` は、RDSのエンドポイントに変更する必要がある
        - EC2インスタンス作成前に、あらかじめRDSを作っておき、RDSのエンドポイントで書き換えた上でインスタンス作成をすることをオススメする（こうすることで、アプリの再起動は不要となる）
        - あとから、セッションマネージャーで接続し、nano 等で編集することでも可能だが、アプリの再起動が必要
           - `/var/www/html`配下の`init_db.js`と`server.js`の2箇所を書き換える
           - 変更を反映させるためには、 `sudo systemctl restart employee-app` にてアプリを再起動する必要がある
           - `node init_db.js`の実行が必要かもしれない
    - 参考(トラブル発生時に解決のヒントとして提供): [アプリケーション概要](https://github.com/haw/aws-education-hands-on/blob/main/day3/db-lab/materials/nodejs-app-overview.md)
- **高度な詳細**: IAMインスタンスプロファイルに `LabInstanceProfile` を設定し、セッションマネージャーで接続できるようにしておくこと

##### **ヒント**

- トラブル発生時は、 `sudo systemctl status employee-app` で状況がわかる。たいていの場合、データベースのエンドポイント関連の設定ミスが考えられる。
- 設定を変更したら、 `sudo systemctl restart employee-app` でアプリを再起動すること
- 他には、データベースのセキュリティグループの設定にミスがあることが考えられる

#### 4. データベース（RDS）
- **エンジン**: MySQL 8.4.6
- **テンプレート**: サンドボックス
- **マスターユーザー名**: `admin`
- **認証情報管理**: `セルフマネージド`
- **マスターパスワード**: `password123`
- **インスタンスクラス**: db.t3.micro
- **ストレージ**: 20GB
- **配置**: プライベートサブネット
- **追加設定** > **最初のデータベース名**: `employeedb`


### セキュリティ要件

#### セキュリティグループ
1. **ALB用**: HTTP(80) 0.0.0.0/0から許可
2. **Web用**: HTTP(3000) ALBからのみ許可
3. **DB用**: MySQL(3306) Webサーバーからのみ許可

---


## 設問

- a) 作成したVPC名を答えてください。
- b) 作成したRDSのエンドポイントを答えてください。
- c) 作成したロードバランサーのDNS名を答えてください。
- d) 作成したロードバランサーのDNS名にブラウザでアクセスしてください。初期状態で登録されている社員は何名いるかを答えてください。
- e) 作成したロードバランサーのDNS名にブラウザでアクセスしてください。社員を新規追加すると、その社員のIDは何になったかを答えてください。
- f) 作成したロードバランサーのDNS名にブラウザでアクセスしてください。EC2インスタンスの一覧で、1台のEC2インスタンスを停止してください。引き続きアプリケーションは表示できましたか。